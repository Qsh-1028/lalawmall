webpackJsonp([4],{"6V+a":function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0_babel_runtime_core_js_json_stringify__=__webpack_require__("mvHQ"),__WEBPACK_IMPORTED_MODULE_0_babel_runtime_core_js_json_stringify___default=__webpack_require__.n(__WEBPACK_IMPORTED_MODULE_0_babel_runtime_core_js_json_stringify__),__WEBPACK_IMPORTED_MODULE_1_babel_runtime_helpers_toConsumableArray__=__webpack_require__("Gu7T"),__WEBPACK_IMPORTED_MODULE_1_babel_runtime_helpers_toConsumableArray___default=__webpack_require__.n(__WEBPACK_IMPORTED_MODULE_1_babel_runtime_helpers_toConsumableArray__),__WEBPACK_IMPORTED_MODULE_2__components_header__=__webpack_require__("Cz8s"),__WEBPACK_IMPORTED_MODULE_3__controller_funcCommon__=__webpack_require__("deIj"),__WEBPACK_IMPORTED_MODULE_4__config_env__=__webpack_require__("uaSg");__webpack_exports__.a={data:function(){return{relation:"member2clerk",fansopenid:0,orderid:0,chat:{status:1},kefu:{},fans:{},order:{id:0},chatlog:{min:0,psize:100,loading:!1,finished:!1,data:[]},content:"",fastReply:[],faseReplyMsg:"",orders:[],websocket:{},heartCheck:{},status:{fastReply:!1,others:!1,voice:!1},popup:{fastReply:!1,order:!1},showPreLoading:!0,islegal:!1}},methods:{onLoad:function(){var t=this;Object(__WEBPACK_IMPORTED_MODULE_3__controller_funcCommon__.a)({vue:t,url:"manage/kefu/clerk/chat",data:{relation:t.relation,fansopenid:t.fansopenid,kefuunionid:t.kefuunionid,orderid:t.orderid,min:t.chatlog.min,psize:t.chatlog.psize},success:function(e){t.chat=t.util.extend(t.chat,e.chat),t.kefu=t.util.extend(t.kefu,e.kefu),t.fans=t.util.extend(t.fans,e.fans),t.order=t.util.extend(t.order,e.order),t.fastReply=[].concat(__WEBPACK_IMPORTED_MODULE_1_babel_runtime_helpers_toConsumableArray___default()(e.reply)),e.chatlog.logs&&e.chatlog.logs.length>0&&(t.chatlog.data=[].concat(__WEBPACK_IMPORTED_MODULE_1_babel_runtime_helpers_toConsumableArray___default()(e.chatlog.logs)),e.chatlog.logs.length<t.chatlog.psize&&(t.chatlog.finished=!0)),t.chatlog.min=e.chatlog.min,t.chatlog.min||(t.chatlog.finished=!0),t.util.setWXTitle(t.fans.nickname)}})},onLoadMore:function(){var t=this;if(t.chatlog.finished)return t.$nextTick(function(){t.chatlog.loading=!1}),t.util.$toast("没有更多消息了"),!1;Object(__WEBPACK_IMPORTED_MODULE_3__controller_funcCommon__.a)({vue:t,url:"manage/kefu/clerk/more",data:{chatid:t.chat.id,min:t.chatlog.min,psize:t.chatlog.psize},success:function(e){e.chatlog.logs&&e.chatlog.logs.length>0&&(t.chatlog.data=e.chatlog.logs.concat(t.chatlog.data),e.chatlog.logs.length<t.chatlog.psize&&(t.chatlog.finished=!0)),t.chatlog.min=e.chatlog.min,t.chatlog.min||(t.chatlog.finished=!0),t.chatlog.loading=!1}})},onSendMessage:function(t,e){var s=this;return!!s.islegal&&(s.islegal=!1,t||(t=s.content),e||(e="text"),!(!t||""==t)&&void Object(__WEBPACK_IMPORTED_MODULE_3__controller_funcCommon__.c)({vue:s,url:"manage/kefu/clerk/addchat",data:{chatid:s.chat.id,type:e,content:t},success:function(t){s.chatlog.data.push(t.log),"text"==e?s.content="":"orderTakeout"==e&&(s.hasSendOrder=!0)}}))},onConfirmFastReply:function(){var t=this;if(!t.faseReplyMsg||""==t.faseReplyMsg)return!1;Object(__WEBPACK_IMPORTED_MODULE_3__controller_funcCommon__.c)({vue:t,url:"manage/kefu/clerk/addreply",data:{content:t.faseReplyMsg,relation:t.relation},success:function(e){e.reply&&e.reply.length>0&&(t.fastReply=[].concat(__WEBPACK_IMPORTED_MODULE_1_babel_runtime_helpers_toConsumableArray___default()(e.reply))),t.faseReplyMsg="",t.onTogglePopup("fastReply")}})},onUploadImage:function(t){var e=this;e.$toast.loading({mask:!0,message:"上传中...",duration:0}),e.util.image({obj:t,success:function(t,s){if(s.url&&s.filename){var a=s.filename;e.islegal=!0,e.onSendMessage(a,"image"),e.$toast.clear()}},options:{channel:"h5"}})},onScrollBottom:function(){var t=this;t.islegal=!0,setTimeout(function(){var e=t.$refs.chatlog;e.scrollTop=e.scrollHeight},200)},onToggleStatus:function(t){for(var e in this.status)this.status[e]=e==t&&!this.status[e]},onTogglePopup:function(t){if(!t)return!1;this.popup[t]=!this.popup[t]},onSetNotreadZero:function(){Object(__WEBPACK_IMPORTED_MODULE_3__controller_funcCommon__.c)({vue:this,url:"manage/kefu/clerk/zero",data:{chatid:this.chat.id},success:function(t){console.log("清零成功")}})},onOrderClick:function(t){t>0&&(this.onSendMessage(t,"orderTakeout"),this.onTogglePopup("order"))},onShowOrders:function(){var t=this;Object(__WEBPACK_IMPORTED_MODULE_3__controller_funcCommon__.a)({vue:t,url:"manage/kefu/clerk/order",data:{chatid:t.chat.id},success:function(e){var s=e.orders;s&&s.length>0?(t.orders=[].concat(__WEBPACK_IMPORTED_MODULE_1_babel_runtime_helpers_toConsumableArray___default()(s)),t.onTogglePopup("order")):t.util.$toast("该顾客最近未在您的门店下过单")}})},initWebSocket:function(){var t=this,e={timeout:2e4,timeoutObj:null,serverTimeoutObj:null,reset:function(){return this.timeoutObj&&clearTimeout(this.timeoutObj),this.serverTimeoutObj&&clearTimeout(this.serverTimeoutObj),this},start:function(){var e=this;this.reset(),this.timeoutObj=setTimeout(function(){1==t.websocket.readyState&&t.websocket.send(__WEBPACK_IMPORTED_MODULE_0_babel_runtime_core_js_json_stringify___default()({type:"ping",data:{}})),e.serverTimeoutObj=setTimeout(function(){t.websocket.close()},e.timeout)},this.timeout)}};t.heartCheck=e,t.websocket=new WebSocket(__WEBPACK_IMPORTED_MODULE_4__config_env__.d),t.websocket.onopen=t.websocketOnopen,t.websocket.onmessage=t.websocketOnmessage,t.websocket.onerror=t.websocketOnerror,t.websocket.onclose=t.websocketOnclose},websocketOnopen:function(t){this.heartCheck.start(),console.log("webSocket init success")},websocketOnerror:function(t){this.initWebSocket()},websocketOnmessage:function websocketOnmessage(e){var that=this;that.heartCheck.start();var data=eval("("+e.data+")");console.log(data);var type=data.type,result=data.data;switch(type){case"connect":that.onBindClientId(result.clientId);break;case"message":that.chat.id==result.chat.chatid&&(that.chatlog.data.push(result.chat),that.onSetNotreadZero());break;case"ping":console.log("心跳反馈")}},websocketOnclose:function(t){console.log("webSocket close")},onBindClientId:function(t){if(!t)return!1;Object(__WEBPACK_IMPORTED_MODULE_3__controller_funcCommon__.c)({vue:this,url:"manage/kefu/bind/clerk",data:{client_id:t},success:function(t){}})}},mounted:function(){var t=this.util.parseQuery(this.$route.query);this.relation=t.relation,this.fansopenid=t.fansopenid,this.kefuunionid=t.kefuunionid,this.orderid=t.orderid,this.onLoad(),this.initWebSocket()},destroyed:function(){this.websocket.close()},updated:function(){this.onScrollBottom()},components:{PublicHeader:__WEBPACK_IMPORTED_MODULE_2__components_header__.a},computed:{chatLogBottom:function(){var t=96;return 2==this.chat.status?t=56:this.status.fastReply?t=272:this.status.others&&(t=237),t}}}},D57j:function(t,e){},O62G:function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=s("6V+a"),i={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"kefu-chat"}},[s("public-header",{attrs:{title:t.fans.nickname}}),t._v(" "),s("div",{staticClass:"content font-14"},[s("div",{staticClass:"connection"},[1==t.fans.isonline?s("div",{staticClass:"status"},[t._v(t._s(t.fans.online_cn))]):t._e(),t._v(" "),t.fans.mobile?s("div",{staticClass:"call flex c-info"},[s("div",{staticClass:"flex",on:{click:function(e){t.util.jsTel(t.fans.mobile)}}},[s("i",{staticClass:"icon icon-telephone"}),t._v(" "),s("span",[t._v(t._s(t.fans.mobile_cn))])])]):t._e()]),t._v(" "),s("div",{ref:"chatlog",staticClass:"chatlog",style:{bottom:t.chatLogBottom+"px"}},[s("van-pull-refresh",{on:{refresh:function(e){t.onLoadMore()}},model:{value:t.chatlog.loading,callback:function(e){t.$set(t.chatlog,"loading",e)},expression:"chatlog.loading"}},[t.chatlog.data.length>0?[t._l(t.chatlog.data,function(e,a){return[s("div",{staticClass:"log-item",class:{left:1==e.isleft,right:0==e.isleft}},[e.addtime_cn?s("div",{staticClass:"time flex-center margin-15-b"},[s("span",[t._v(t._s(e.addtime_cn))])]):t._e(),t._v(" "),s("div",{staticClass:"detail"},[s("div",{staticClass:"avatar"},[s("img",{staticClass:"img-100",attrs:{src:e.avatar,alt:""}})]),t._v(" "),"text"==e.type?s("div",{staticClass:"text before"},[t._v(t._s(e.content))]):"image"==e.type?s("div",{staticClass:"image",on:{click:function(s){t.util.jsPreviewImage(e.content)}}},[s("img",{attrs:{src:e.content,alt:""}})]):"orderTakeout"==e.type?s("div",{staticClass:"order before",on:{click:function(s){t.util.jsUrl("pages/order/detail",{id:e.orderid})}}},[s("div",{staticClass:"c-gray"},[t._v("订单信息")]),t._v(" "),s("div",{staticClass:"flex-lr margin-10-t"},[s("div",{staticClass:"store-logo"},[s("img",{staticClass:"img-100",attrs:{src:e.content.logo,alt:""}})]),t._v(" "),s("div",{staticClass:"order-info"},[s("div",{staticClass:"flex-lr"},[s("div",{staticClass:"store-title ellipsis"},[t._v(t._s(e.content.title))]),t._v(" "),s("div",{staticClass:"order-status font-12 ellipsis"},[t._v(t._s(e.content.status_cn))])]),t._v(" "),s("div",{staticClass:"flex-lr c-gray"},[s("div",{staticClass:"goods-title ellipsis"},[t._v(t._s(e.content.goods_title))]),t._v(" "),s("div",{staticClass:"order-fee font-12 ellipsis"},[t._v("实付"),s("span",{staticClass:"c-default"},[t._v(t._s(t.Lang.dollarSign)+t._s(e.content.final_fee)+t._s(t.Lang.dollarSignCn))])])])])])]):t._e(),t._v(" "),t._e()])])]})]:t._e(),t._v(" "),t._e()],2)],1),t._v(" "),1==t.chat.status?s("div",{staticClass:"tools"},[s("div",{staticClass:"guess flex padding-15-lr padding-10-tb van-hairline--bottom"},[s("span",{staticClass:"c-gray margin-10-r"},[t._v("猜你喜欢")]),t._v(" "),s("ul",{staticClass:"guess-list"},[s("li",{staticClass:"guess-item",on:{click:function(e){t.onShowOrders()}}},[t._v("最近订单")])])]),t._v(" "),s("div",{staticClass:"main flex-lr"},[t._e(),t._v(" "),s("input",{directives:[{name:"model",rawName:"v-model",value:t.content,expression:"content"}],staticClass:"text",attrs:{type:"text",placeholder:"输入消息..."},domProps:{value:t.content},on:{keyup:function(e){if(!("button"in e)&&t._k(e.keyCode,"enter",13,e.key,"Enter"))return null;t.onSendMessage()},input:function(e){e.target.composing||(t.content=e.target.value)}}}),t._v(" "),s("i",{staticClass:"icon icon-sort margin-15-lr",on:{click:function(e){t.onToggleStatus("fastReply")}}}),t._v(" "),t.content?s("div",{staticClass:"btn-send",on:{click:function(e){t.onSendMessage()}}},[t._v("发送")]):s("i",{staticClass:"icon icon-add",on:{click:function(e){t.onToggleStatus("others")}}})]),t._v(" "),t.status.fastReply?s("ul",{staticClass:"common-reply van-hairline--top"},[t._l(t.fastReply,function(e,a){return[s("li",{staticClass:"reply-item van-hairline--bottom",on:{click:function(s){t.onSendMessage(e,"text")}}},[t._v(t._s(e))])]}),t._v(" "),s("li",{staticClass:"reply-item flex-center c-info"},[s("i",{staticClass:"icon icon-add font-18 margin-5-r"}),t._v(" "),s("span",{on:{click:function(e){t.onTogglePopup("fastReply")}}},[t._v("添加常用语")])])],2):t._e(),t._v(" "),t.status.others?s("ul",{staticClass:"others"},[s("li",{staticClass:"other-item"},[s("div",{staticClass:"other-item-inner"},[s("input",{staticClass:"weui-uploader__input",attrs:{type:"file",multiple:"multiple",accept:"image/*"},on:{change:function(e){t.onUploadImage(e)}}}),t._v(" "),s("i",{staticClass:"icon icon-pic-filling"}),t._v(" "),s("span",{staticClass:"margin-10-t"},[t._v("照片")])])])]):t._e()]):s("div",{staticClass:"close-tips ellipsis van-hairline--top"},[t._v(t._s(t.chat.reason))])]),t._v(" "),s("van-popup",{staticClass:"fast-reply-popup",model:{value:t.popup.fastReply,callback:function(e){t.$set(t.popup,"fastReply",e)},expression:"popup.fastReply"}},[s("div",{staticClass:"title"},[t._v("添加快捷短语")]),t._v(" "),s("van-field",{staticClass:"border-0px",attrs:{type:"textarea",placeholder:"例如: 我不能吃辣, 麻烦少放些辣椒",rows:"4"},model:{value:t.faseReplyMsg,callback:function(e){t.faseReplyMsg=e},expression:"faseReplyMsg"}}),t._v(" "),s("div",{staticClass:"flex-center van-hairline--top"},[s("div",{staticClass:"flex-1 flex-center padding-15-tb van-hairline--right",on:{click:function(e){t.onTogglePopup("fastReply")}}},[t._v("取消")]),t._v(" "),s("div",{staticClass:"flex-1 flex-center padding-15-tb c-gray",on:{click:t.onConfirmFastReply}},[t._v("确认添加")])])],1),t._v(" "),s("van-popup",{staticClass:"order-list-popup",attrs:{position:"bottom"},model:{value:t.popup.order,callback:function(e){t.$set(t.popup,"order",e)},expression:"popup.order"}},[s("div",{staticClass:"title padding-15 flex-lr van-hairline--bottom"},[s("div",{staticClass:"font-15"},[t._v("点击发送订单"),s("span",{staticClass:"c-gray font-12 margin-10-l"},[t._v("展示最近5个订单")])]),t._v(" "),s("i",{staticClass:"icon icon-close font-20",on:{click:function(e){t.onTogglePopup("order")}}})]),t._v(" "),s("div",{staticClass:"popup-content"},[t._l(t.orders,function(e,a){return s("div",{key:e.id,staticClass:"order-item padding-15-l bg-default font-15",on:{click:function(s){t.onOrderClick(e.id)}}},[s("div",{staticClass:"item-inner ",class:{"van-hairline--top":a>0}},[s("div",{staticClass:"store-logo"},[s("img",{staticClass:"img-100",attrs:{src:e.logo,alt:""}})]),t._v(" "),s("div",{staticClass:"info"},[s("div",{staticClass:"flex-lr w-100"},[s("div",{staticClass:"store-title ellipsis"},[t._v(t._s(e.title))]),t._v(" "),s("div",{staticClass:"order-status ellipsis"},[t._v(t._s(e.status_cn))])]),t._v(" "),s("div",{staticClass:"flex-lr c-gray padding-10-t"},[s("div",{staticClass:"goods-title ellipsis"},[t._v(t._s(e.goods_title))]),t._v(" "),s("div",{staticClass:"order-fee ellipsis"},[t._v("\n\t\t\t\t\t\t\t\t实付"),s("span",{staticClass:"c-default"},[t._v(t._s(t.Lang.dollarSign)+t._s(e.final_fee))])])])])])])}),t._v(" "),t._e()],2)]),t._v(" "),t.showPreLoading?s("iloading"):t._e()],1)},staticRenderFns:[]};var o=function(t){s("D57j")},n=s("VU/8")(a.a,i,!1,o,null,null);e.default=n.exports}});
//# sourceMappingURL=4.c4f39e2fb63b810d1fc7.js.map